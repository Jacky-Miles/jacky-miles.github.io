<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Today's Musical Scale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f7f7fa; margin: 0; padding: 2em;}
    h1 { text-align: center; }
    .scale-box { margin: 2em auto; max-width: 400px; background: #fff; border-radius: 1em; box-shadow: 0 2px 8px #aaa3; padding: 2em; text-align: center; }
    .scale-today { font-size: 2em; color: #336; margin: 1em 0; }
    .scale-yesterday { font-size: 1.2em; color: #666; margin: 0.5em 0 1em; }
    .label { font-weight: bold; color: #555; }
    .notes-list { margin: 0.5em 0 1.5em; font-size: 1.1em; color: #225; }
    .debug-controls { margin: 1em auto; max-width: 400px; padding: 1em; background: #eef; border-radius: 0.5em; text-align: center; }
    .debug-controls label { margin-right: 0.5em; }
    .debug-controls input, .debug-controls select { margin: 0 0.5em; }
  </style>
</head>
<body>
  <h1>Musical Scale of the Day</h1>
  <div class="debug-controls">
    <label for="debug-month">Month:</label>
    <select id="debug-month"></select>
    <label for="debug-day">Day:</label>
    <select id="debug-day"></select>
    <button id="debug-update">Update</button>
  </div>
  <div class="scale-box" id="scales"></div>
<script>
const ROOTS = ["A", "Ab", "B", "Bb", "C", "C#", "D", "Db", "E", "Eb", "F", "F#", "G", "Gb"];
const TYPES = ["Natural", "Melodic Minor", "Harmonic Minor"];
const ALL_SCALES = [];
ROOTS.forEach(root => TYPES.forEach(type => ALL_SCALES.push(`${root} ${type}`));
const CHROMATIC = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"];
const ROOT_INDEX = {
  "C": 0,  "C#": 1, "Db": 1,
  "D": 2,
  "Eb": 3, "D#": 3,
  "E": 4,
  "F": 5,
  "F#": 6, "Gb": 6,
  "G": 7,
  "Ab": 8, "G#": 8,
  "A": 9,
  "Bb": 10, "A#": 10,
  "B": 11
};
const SCALE_FORMULAS = {
  "Natural":        [2, 1, 2, 2, 1, 2, 2],
  "Melodic Minor":  [2, 1, 2, 2, 2, 2, 1],
  "Harmonic Minor": [2, 1, 2, 2, 1, 3, 1]
};
function getScaleNotes(root, type) {
  let formula = SCALE_FORMULAS[type];
  let idx = ROOT_INDEX[root];
  let notes = [CHROMATIC[idx]];
  for (let i = 0; i < formula.length; i++) {
    idx = (idx + formula[i]) % 12;
    notes.push(CHROMATIC[idx]);
  }
  return notes.slice(0, 7);
}
function mulberry32(seed) {
  return function() {
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}
function hashDate(str) {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function scaleForDay(dayOffset, startDate, calendarCache) {
  let date = new Date(startDate);
  date.setDate(date.getDate() + dayOffset);
  let dateStr = date.toISOString().slice(0,10);
  if (calendarCache[dateStr]) return calendarCache[dateStr];
  let recent = [];
  for (let i = 1; i <= 7; i++) {
    let prevDate = new Date(date);
    prevDate.setDate(prevDate.getDate() - i);
    let prevStr = prevDate.toISOString().slice(0,10);
    if (calendarCache[prevStr]) recent.push(calendarCache[prevStr]);
  }
  let seed = hashDate(dateStr + "-fixed-seed");
  let rng = mulberry32(seed);
  let eligible = ALL_SCALES.filter(s => !recent.includes(s));
  let pick = eligible[Math.floor(rng() * eligible.length)];
  calendarCache[dateStr] = pick;
  return pick;
}
// ----- Debug controls -----
function populateMonthDayFields() {
  // Months
  const monthSelect = document.getElementById("debug-month");
  monthSelect.innerHTML = "";
  for (let m = 0; m < 12; m++) {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = new Date(2025, m, 1).toLocaleString('default', { month: 'long' });
    monthSelect.appendChild(opt);
  }
  // Set current month
  const now = new Date();
  monthSelect.value = now.getMonth();
  // Days
  updateDaysDropdown(now.getFullYear(), now.getMonth(), now.getDate());
  // Update days when month changes
  monthSelect.addEventListener("change", function() {
    updateDaysDropdown(now.getFullYear(), parseInt(monthSelect.value, 10), 1);
  });
}
function updateDaysDropdown(year, month, selectedDay) {
  const daySelect = document.getElementById("debug-day");
  daySelect.innerHTML = "";
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  for (let d = 1; d <= daysInMonth; d++) {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    daySelect.appendChild(opt);
  }
  // Select current day if valid, else first day
  daySelect.value = selectedDay <= daysInMonth ? selectedDay : 1;
}
function getDebugDate() {
  const month = parseInt(document.getElementById("debug-month").value, 10);
  const day = parseInt(document.getElementById("debug-day").value, 10);
  const year = (new Date()).getFullYear();
  return new Date(Date.UTC(year, month, day));
}
function renderScale(scaleStr, labelClass, labelText) {
  let [root, ...typeArr] = scaleStr.split(" ");
  let type = typeArr.join(" ");
  let notes = getScaleNotes(root, type);
  return `<div>
    <span class="label">${labelText}</span>
    <div class="${labelClass}">${scaleStr}</div>
    <div class="notes-list">${notes.join(", ")}</div>
  </div>`;
}
function updateScalesDisplay() {
  let calendarCache = {};
  let debugDate = getDebugDate();
  let todayScale = scaleForDay(0, debugDate, calendarCache);
  let yesterdayScale = scaleForDay(-1, debugDate, calendarCache);
  let html = renderScale(todayScale, "scale-today", "Today");
  if (yesterdayScale) {
    html += renderScale(yesterdayScale, "scale-yesterday", "Yesterday");
  }
  document.getElementById("scales").innerHTML = html;
}
populateMonthDayFields();
updateScalesDisplay();
document.getElementById("debug-update").onclick = updateScalesDisplay;
document.getElementById("debug-month").onchange = function() {
  const year = (new Date()).getFullYear();
  const month = parseInt(document.getElementById("debug-month").value, 10);
  updateDaysDropdown(year, month, 1);
  updateScalesDisplay();
};
document.getElementById("debug-day").onchange = updateScalesDisplay;
</script>
</body>
</html>
